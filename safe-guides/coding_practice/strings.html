<!DOCTYPE HTML>
<html lang="zh" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>字符串 - RustCodingGuidelines</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../favicon.png">
        
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        
        <link rel="stylesheet" href="../../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><li class="part-title">介绍</li><li class="chapter-item "><a href="../../index.html"><strong aria-hidden="true">1.</strong> Rust 编码规范介绍</a></li><li class="chapter-item "><a href="../../contribution.html"><strong aria-hidden="true">2.</strong> 贡献说明</a></li><li class="chapter-item affix "><li class="part-title">安全编码规范</li><li class="chapter-item "><a href="../../safe-guides/intro.html"><strong aria-hidden="true">3.</strong> 前言</a></li><li class="chapter-item "><a href="../../safe-guides/dev_env.html"><strong aria-hidden="true">4.</strong> 开发环境</a></li><li class="chapter-item "><a href="../../safe-guides/code_style.html"><strong aria-hidden="true">5.</strong> 代码风格</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../safe-guides/code_style/naming.html"><strong aria-hidden="true">5.1.</strong> 命名</a></li><li class="chapter-item "><a href="../../safe-guides/code_style/fmt.html"><strong aria-hidden="true">5.2.</strong> 格式</a></li><li class="chapter-item "><a href="../../safe-guides/code_style/comments.html"><strong aria-hidden="true">5.3.</strong> 注释</a></li></ol></li><li class="chapter-item expanded "><a href="../../safe-guides/coding_practice.html"><strong aria-hidden="true">6.</strong> 编程实践</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../safe-guides/coding_practice/consts.html"><strong aria-hidden="true">6.1.</strong> 常量</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/statics.html"><strong aria-hidden="true">6.2.</strong> 静态变量</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/variables.html"><strong aria-hidden="true">6.3.</strong> 本地变量</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/data-type.html"><strong aria-hidden="true">6.4.</strong> 数据类型</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../safe-guides/coding_practice/data-type/unit.html"><strong aria-hidden="true">6.4.1.</strong> 单元类型</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/data-type/bool.html"><strong aria-hidden="true">6.4.2.</strong> 布尔</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/data-type/char.html"><strong aria-hidden="true">6.4.3.</strong> 字符</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/data-type/int.html"><strong aria-hidden="true">6.4.4.</strong> 整数</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/data-type/float.html"><strong aria-hidden="true">6.4.5.</strong> 浮点数</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/data-type/ref.html"><strong aria-hidden="true">6.4.6.</strong> 引用</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/data-type/slice.html"><strong aria-hidden="true">6.4.7.</strong> 切片</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/data-type/tuple.html"><strong aria-hidden="true">6.4.8.</strong> 元组</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/data-type/array.html"><strong aria-hidden="true">6.4.9.</strong> 固定长度数组</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/data-type/vec.html"><strong aria-hidden="true">6.4.10.</strong> 动态数组</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/data-type/struct.html"><strong aria-hidden="true">6.4.11.</strong> 结构体</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/data-type/enum.html"><strong aria-hidden="true">6.4.12.</strong> 枚举体</a></li></ol></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/expr.html"><strong aria-hidden="true">6.5.</strong> 表达式</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/control-flow.html"><strong aria-hidden="true">6.6.</strong> 流程控制</a></li><li class="chapter-item expanded "><a href="../../safe-guides/coding_practice/strings.html" class="active"><strong aria-hidden="true">6.7.</strong> 字符串</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/collections.html"><strong aria-hidden="true">6.8.</strong> 集合容器</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/fn-and-closure.html"><strong aria-hidden="true">6.9.</strong> 函数与闭包</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/generic.html"><strong aria-hidden="true">6.10.</strong> 泛型</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/traits.html"><strong aria-hidden="true">6.11.</strong> 特质</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../safe-guides/coding_practice/traits/std-buildin.html"><strong aria-hidden="true">6.11.1.</strong> 标准库内置 trait</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/traits/trait-object.html"><strong aria-hidden="true">6.11.2.</strong> trait 对象</a></li></ol></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/error-handle.html"><strong aria-hidden="true">6.12.</strong> 错误处理</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/memory.html"><strong aria-hidden="true">6.13.</strong> 内存管理</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../safe-guides/coding_practice/memory/lifetime.html"><strong aria-hidden="true">6.13.1.</strong> 生存期</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/memory/box.html"><strong aria-hidden="true">6.13.2.</strong> Box&lt;T&gt;</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/memory/drop.html"><strong aria-hidden="true">6.13.3.</strong> Drop 析构</a></li></ol></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/module.html"><strong aria-hidden="true">6.14.</strong> 模块</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/cargo.html"><strong aria-hidden="true">6.15.</strong> 包管理</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/macros.html"><strong aria-hidden="true">6.16.</strong> 宏</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../safe-guides/coding_practice/macros/decl.html"><strong aria-hidden="true">6.16.1.</strong> 声明宏</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/macros/proc.html"><strong aria-hidden="true">6.16.2.</strong> 过程宏</a></li></ol></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/threads.html"><strong aria-hidden="true">6.17.</strong> 多线程</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../safe-guides/coding_practice/threads/lock.html"><strong aria-hidden="true">6.17.1.</strong> 锁同步</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/threads/lock-free.html"><strong aria-hidden="true">6.17.2.</strong> 无锁</a></li></ol></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/async-await.html"><strong aria-hidden="true">6.18.</strong> 异步编程</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/unsafe_rust.html"><strong aria-hidden="true">6.19.</strong> Unsafe Rust</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../safe-guides/coding_practice/unsafe_rust/safe_abstract.html"><strong aria-hidden="true">6.19.1.</strong> 安全抽象</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/unsafe_rust/raw_ptr.html"><strong aria-hidden="true">6.19.2.</strong> 裸指针操作</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/unsafe_rust/union.html"><strong aria-hidden="true">6.19.3.</strong> 联合体</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/unsafe_rust/mem.html"><strong aria-hidden="true">6.19.4.</strong> 内存</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/unsafe_rust/ffi.html"><strong aria-hidden="true">6.19.5.</strong> FFi 规范</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/unsafe_rust/io.html"><strong aria-hidden="true">6.19.6.</strong> I/O</a></li></ol></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/no-std.html"><strong aria-hidden="true">6.20.</strong> no-std</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/io.html"><strong aria-hidden="true">6.21.</strong> I/O</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/security.html"><strong aria-hidden="true">6.22.</strong> 信息安全</a></li><li class="chapter-item "><a href="../../safe-guides/coding_practice/others.html"><strong aria-hidden="true">6.23.</strong> 其他</a></li></ol></li><li class="chapter-item "><a href="../../safe-guides/Appendix/toc.html"><strong aria-hidden="true">7.</strong> 附录</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../safe-guides/Appendix/test.html"><strong aria-hidden="true">7.1.</strong> 测试</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../safe-guides/Appendix/test/unit_test.html"><strong aria-hidden="true">7.1.1.</strong> 单元测试</a></li><li class="chapter-item "><a href="../../safe-guides/Appendix/test/benchmark.html"><strong aria-hidden="true">7.1.2.</strong> 基准测试</a></li><li class="chapter-item "><a href="../../safe-guides/Appendix/test/fuzz.html"><strong aria-hidden="true">7.1.3.</strong> 模糊测试</a></li></ol></li><li class="chapter-item "><a href="../../safe-guides/Appendix/terms.html"><strong aria-hidden="true">7.2.</strong> 术语解释</a></li><li class="chapter-item "><a href="../../safe-guides/Appendix/templates/intro.html"><strong aria-hidden="true">7.3.</strong> 模板</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../safe-guides/Appendix/templates/rustfmt.toml.html"><strong aria-hidden="true">7.3.1.</strong> rustfmt 模板</a></li><li class="chapter-item "><a href="../../safe-guides/Appendix/templates/clippy.toml.html"><strong aria-hidden="true">7.3.2.</strong> clippy 模板</a></li><li class="chapter-item "><a href="../../safe-guides/Appendix/templates/deny.toml.html"><strong aria-hidden="true">7.3.3.</strong> deny 模板</a></li></ol></li><li class="chapter-item "><a href="../../safe-guides/Appendix/tools/intro.html"><strong aria-hidden="true">7.4.</strong> 工具链</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../safe-guides/Appendix/tools/rustfmt.html"><strong aria-hidden="true">7.4.1.</strong> rustfmt</a></li><li class="chapter-item "><a href="../../safe-guides/Appendix/tools/noisy-clippy.html"><strong aria-hidden="true">7.4.2.</strong> noisy-clippy</a></li><li class="chapter-item "><a href="../../safe-guides/Appendix/tools/cargo-udeps.html"><strong aria-hidden="true">7.4.3.</strong> cargo-udeps</a></li></ol></li></ol></li><li class="chapter-item "><li class="part-title">领域最佳实践</li><li class="chapter-item "><a href="../../best-practices/intro.html"><strong aria-hidden="true">8.</strong> 介绍</a></li><li class="chapter-item "><a href="../../best-practices/hpc.html"><strong aria-hidden="true">9.</strong> 高性能计算</a></li><li class="chapter-item "><a href="../../best-practices/embedded.html"><strong aria-hidden="true">10.</strong> 嵌入式 Rust</a></li><li class="chapter-item "><a href="../../best-practices/databases.html"><strong aria-hidden="true">11.</strong> 数据库</a></li><li class="chapter-item "><a href="../../best-practices/games.html"><strong aria-hidden="true">12.</strong> 游戏</a></li><li class="chapter-item "><a href="../../best-practices/cli_app.html"><strong aria-hidden="true">13.</strong> Cli App</a></li><li class="chapter-item "><a href="../../best-practices/gui.html"><strong aria-hidden="true">14.</strong> GUI</a></li><li class="chapter-item "><a href="../../best-practices/web.html"><strong aria-hidden="true">15.</strong> Web 开发</a></li><li class="chapter-item "><a href="../../best-practices/networks.html"><strong aria-hidden="true">16.</strong> 网络服务</a></li><li class="chapter-item "><a href="../../best-practices/webassembly.html"><strong aria-hidden="true">17.</strong> WebAssembly</a></li><li class="chapter-item affix "><li class="part-title">Cheat Sheet</li><li class="chapter-item "><a href="../../cheat-sheet/index.html"><strong aria-hidden="true">18.</strong> 介绍</a></li><li class="chapter-item affix "><li class="part-title">Rust 优化指南</li><li class="chapter-item "><a href="../../optimizing/intro.html"><strong aria-hidden="true">19.</strong> 介绍</a></li><li class="chapter-item affix "><li class="part-title">Rust Cookbook</li><li class="chapter-item "><a href="../../cookbook/intro.html"><strong aria-hidden="true">20.</strong> 介绍</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">RustCodingGuidelines</h1>

                    <div class="right-buttons">
                        
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/Rust-Coding-Guidelines/rust-coding-guidelines-zh" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#字符串" id="字符串">字符串</a></h1>
<p>Rust 中字符串是有效的 UTF-8 编码的字节数组。</p>
<p>Rust 字符串类型众多，但本节内容主要围绕 ：<code>String</code> / <code>&amp;str</code></p>
<hr />
<h2><a class="header" href="#pstr01---处理字符串非必要不要按字符来处理应该按字节处理" id="pstr01---处理字符串非必要不要按字符来处理应该按字节处理">P.STR.01   处理字符串非必要不要按字符来处理，应该按字节处理</a></h2>
<p><strong>【描述】</strong></p>
<p>处理字符串有两种方式，一种是按字符处理，即把字符串转为字符数组<code>[char]</code>，另一种是直接按字节处理<code>[u8]</code>。</p>
<p>两者之间的一些区别：</p>
<ul>
<li><code>[char]</code>  保证是有效的 Unicode，但不一定是有效的 UTF-8，一般将其看作是 UTF-32 。将字符数组转换为字符串需要注意。</li>
<li><code>[u8]</code> 不一定是有效的字符串，它比 <code>[char]</code> 节省内存。将其转换为字符串需要检查 <code>UTF-8</code>编码。</li>
</ul>
<h2><a class="header" href="#pstr02---创建字符串时可以预先分配大约足够的容量来避免后续操作中产生多次分配" id="pstr02---创建字符串时可以预先分配大约足够的容量来避免后续操作中产生多次分配">P.STR.02   创建字符串时，可以预先分配大约足够的容量来避免后续操作中产生多次分配</a></h2>
<p><strong>【描述】</strong></p>
<p>预分配足够的容量，避免后续内存分配，可以提升代码性能。</p>
<p>【正例】</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let mut output = String::with_capacity(input.len());
<span class="boring">}
</span></code></pre></pre>
<p>【反例】</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let mut output = String::new();
<span class="boring">}
</span></code></pre></pre>
<h2><a class="header" href="#pstr03----可以使用-cowstr-来代替直接使用字符串它可以减少-copy" id="pstr03----可以使用-cowstr-来代替直接使用字符串它可以减少-copy">P.STR.03    可以使用 <code>Cow&lt;str&gt;</code> 来代替直接使用字符串，它可以减少 Copy</a></h2>
<p><strong>【描述】</strong></p>
<p>使用 <code>Cow&lt;str&gt;</code> 作为字符串处理函数参数和返回值，可以尽可能地减少数据Copy 和 内存分配。当字符串没有修改的时候，实际使用的是 <code>&amp;'a str</code>，只有当数据修改的时候才会使用<code>String</code>。对于读操作大于写操作的场景，使用 <code>Cow&lt;str&gt;</code> 比较合适。</p>
<p>【正例】</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// 对输入的字符串进行转义
pub fn naive&lt;'a, S: Into&lt;Cow&lt;'a, str&gt;&gt;&gt;(input: S) -&gt; Cow&lt;'a, str&gt; {
    let input = input.into();
    fn is_trouble(c: char) -&gt; bool {
        c == '&lt;' || c == '&gt;' || c == '&amp;'
    }

    if input.contains(is_trouble) {
        let mut output = String::with_capacity(input.len());
        for c in input.chars() {
            match c {
                '&lt;' =&gt; output.push_str(&quot;&amp;lt;&quot;),
                '&gt;' =&gt; output.push_str(&quot;&amp;gt;&quot;),
                '&amp;' =&gt; output.push_str(&quot;&amp;amp;&quot;),
                _ =&gt; output.push(c)
            }
        }
        // 只有在字符串修改的时候才使用 String
        Cow::Owned(output)
    } else {
        //其他情况使用 &amp;str
        input
    }
}
<span class="boring">}
</span></code></pre></pre>
<h2><a class="header" href="#pstr04-----在使用内建字符串处理函数或方法的时候应该注意避免隐藏的嵌套迭代-或-多次迭代" id="pstr04-----在使用内建字符串处理函数或方法的时候应该注意避免隐藏的嵌套迭代-或-多次迭代">P.STR.04     在使用内建字符串处理函数或方法的时候，应该注意避免隐藏的嵌套迭代 或 多次迭代</a></h2>
<p><strong>【描述】</strong></p>
<p>比如 <code>contains</code> 函数的实现就是按字符遍历字符串，但是如果你将它用于一个字符串的迭代处理中，就会产生嵌套迭代，时间复杂度从你以为的 <code>O(n)</code> 变成了 <code>O(n^2)</code>。没有将其用于迭代中，也有可能产生多次迭代，<code>O(n)</code> 变为 <code>O(n+m)</code> 。 为了避免这个问题，我们可以用 <code>find</code>  来代替 <code>contains</code>。</p>
<p>所以，在使用内建函数的时候要注意它的实现，选择合适的函数或方法，来避免这类问题。</p>
<p>【正例】</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// 对输入的字符串进行转义
pub fn find&lt;'a, S: Into&lt;Cow&lt;'a, str&gt;&gt;&gt;(input: S) -&gt; Cow&lt;'a, str&gt; {
    let input = input.into();
    fn is_trouble(c: char) -&gt; bool {
        c == '&lt;' || c == '&gt;' || c == '&amp;'
    }
    
    // 使用 find 而非 contains
    // find 使用模式查找，可以返回匹配字符的位置信息
    let first = input.find(is_trouble);
    
    // 利用 find 的位置信息，避免第二次遍历
    if let Some(first) = first {
        let mut output = String::from(&amp;input[0..first]);
        output.reserve(input.len() - first);
        let rest = input[first..].chars();
        for c in rest {
            match c {
                '&lt;' =&gt; output.push_str(&quot;&amp;lt;&quot;),
                '&gt;' =&gt; output.push_str(&quot;&amp;gt;&quot;),
                '&amp;' =&gt; output.push_str(&quot;&amp;amp;&quot;),
                _ =&gt; output.push(c),
            }
        }

        Cow::Owned(output)
    } else {
        input.into()
    }
}
<span class="boring">}
</span></code></pre></pre>
<h2><a class="header" href="#pstr05-----只有在合适的场景下才使用第三方库正则表达式regex" id="pstr05-----只有在合适的场景下才使用第三方库正则表达式regex">P.STR.05     只有在合适的场景下，才使用第三方库正则表达式<code>regex</code></a></h2>
<p><strong>【描述】</strong></p>
<p>合适的场景包括：</p>
<ol>
<li>不在乎编译文件大小。<code>regex</code> 正则引擎是第三方库，引入它的时候意味着还会引入其他依赖，对编译文件大小有要求可以考虑，是否使用 <code>Cow</code> 和 内建函数方法来替代。</li>
<li>对字符串查找性能有极致需求。<code>regex</code> 的  <code>find</code> 实现性能很好，但是 <code>replace</code> 替换就不一定了。对于替换需求，在适合 <code>Cow&lt;str&gt;</code> 的场景下，使用 <code>Cow</code> 和 内建函数方法来替代 regex 可能更好。</li>
</ol>
<h2><a class="header" href="#pstr06----在拼接字符串时建议使用-format" id="pstr06----在拼接字符串时建议使用-format">P.STR.06    在拼接字符串时，建议使用 <code>format!</code></a></h2>
<p><strong>【描述】</strong></p>
<p>使用 <code>format!</code> 组合字符串是最简单和直观的方法，尤其是在字符串和非字符串混合的情况下。但追加字符串还是建议使用 <code>push</code>。</p>
<p>【正例】</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span> let hw = format!(&quot;Hello {}!&quot;, name)
<span class="boring">}
</span></code></pre></pre>
<hr />
<h2><a class="header" href="#gstr01---在实现--display-trait-时不要调用-to_string-方法" id="gstr01---在实现--display-trait-时不要调用-to_string-方法">G.STR.01   在实现  <code>Display</code> trait 时不要调用 <code>to_string()</code> 方法</a></h2>
<h3><a class="header" href="#级别建议" id="级别建议">【级别：建议】</a></h3>
<p>建议按此规范执行。</p>
<h3><a class="header" href="#lint-检测" id="lint-检测">【Lint 检测】</a></h3>
<table><thead><tr><th>lint name</th><th>Clippy 可检测</th><th>Rustc 可检测</th><th>Lint Group</th><th>level</th></tr></thead><tbody>
<tr><td><a href="https://rust-lang.github.io/rust-clippy/master/#to_string_in_display">to_string_in_display</a></td><td>yes</td><td>no</td><td>correctness</td><td>deny</td></tr>
</tbody></table>
<h3><a class="header" href="#描述" id="描述">【描述】</a></h3>
<p>因为 <code>to_string</code> 是间接通过 <code>Display</code> 来实现的，如果实现 <code>Display</code> 的时候再使用 <code>to_tring</code> 的话，将会无限递归。</p>
<p>【正例】</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use std::fmt;

struct Structure(i32);
impl fmt::Display for Structure {
    fn fmt(&amp;self, f: &amp;mut fmt::Formatter) -&gt; fmt::Result {
        write!(f, &quot;{}&quot;, self.0)
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>【反例】</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use std::fmt;

struct Structure(i32);
impl fmt::Display for Structure {
    fn fmt(&amp;self, f: &amp;mut fmt::Formatter) -&gt; fmt::Result {
        write!(f, &quot;{}&quot;, self.to_string())
    }
}
<span class="boring">}
</span></code></pre></pre>
<h2><a class="header" href="#gstr02---在追加字符串时使用-push_str方法可读性更强" id="gstr02---在追加字符串时使用-push_str方法可读性更强">G.STR.02   在追加字符串时使用 <code>push_str</code>方法可读性更强</a></h2>
<h3><a class="header" href="#级别建议-1" id="级别建议-1">【级别：建议】</a></h3>
<p>建议按此规范执行。</p>
<h3><a class="header" href="#lint-检测-1" id="lint-检测-1">【Lint 检测】</a></h3>
<table><thead><tr><th>lint name</th><th>Clippy 可检测</th><th>Rustc 可检测</th><th>Lint Group</th><th>level</th></tr></thead><tbody>
<tr><td><a href="https://rust-lang.github.io/rust-clippy/master/#string_add_assign">string_add_assign</a></td><td>yes</td><td>no</td><td>pedantic</td><td>allow</td></tr>
<tr><td><a href="https://rust-lang.github.io/rust-clippy/master/#string_add">string_add</a></td><td>yes</td><td>no</td><td>restriction</td><td>allow</td></tr>
</tbody></table>
<h3><a class="header" href="#描述-1" id="描述-1">【描述】</a></h3>
<p>【正例】</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let mut x = &quot;Hello&quot;.to_owned();

// More readable
x += &quot;, World&quot;;
x.push_str(&quot;, World&quot;);
<span class="boring">}
</span></code></pre></pre>
<p>【反例】</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let mut x = &quot;Hello&quot;.to_owned();
x = x + &quot;, World&quot;;
<span class="boring">}
</span></code></pre></pre>
<h2><a class="header" href="#gstr03----将只包含-ascii字符的字符串字面量转为字节序列可以直接使用bstr-语法代替调用as_bytes方法" id="gstr03----将只包含-ascii字符的字符串字面量转为字节序列可以直接使用bstr-语法代替调用as_bytes方法">G.STR.03    将只包含 <code>ASCII</code>字符的字符串字面量转为字节序列可以直接使用<code>b&quot;str&quot;</code> 语法代替调用<code>as_bytes</code>方法</a></h2>
<h3><a class="header" href="#级别建议-2" id="级别建议-2">【级别：建议】</a></h3>
<p>建议按此规范执行。</p>
<h3><a class="header" href="#lint-检测-2" id="lint-检测-2">【Lint 检测】</a></h3>
<table><thead><tr><th>lint name</th><th>Clippy 可检测</th><th>Rustc 可检测</th><th>Lint Group</th><th>level</th></tr></thead><tbody>
<tr><td><a href="https://rust-lang.github.io/rust-clippy/master/#string_lit_as_bytes">string_lit_as_bytes</a></td><td>yes</td><td>no</td><td>nursery</td><td>allow</td></tr>
</tbody></table>
<h3><a class="header" href="#描述-2" id="描述-2">【描述】</a></h3>
<p>这是为了增强可读性，让代码更简洁。</p>
<p>注意，<code>&quot;str&quot;.as_bytes()</code> 并不等价于  <code>b&quot;str&quot;</code>，而是等价于 <code>&amp;b&quot;str&quot;[..]</code>  。</p>
<p>【正例】</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let bs = b&quot;a byte string&quot;;
<span class="boring">}
</span></code></pre></pre>
<p>【反例】</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let bs = &quot;a byte string&quot;.as_bytes();
<span class="boring">}
</span></code></pre></pre>
<h2><a class="header" href="#gstr04---需要判断字符串以哪个字符开头或结尾时不要按字符迭代比较" id="gstr04---需要判断字符串以哪个字符开头或结尾时不要按字符迭代比较">G.STR.04   需要判断字符串以哪个字符开头或结尾时，不要按字符迭代比较</a></h2>
<h3><a class="header" href="#级别建议-3" id="级别建议-3">【级别：建议】</a></h3>
<p>建议按此规范执行。</p>
<h3><a class="header" href="#lint-检测-3" id="lint-检测-3">【Lint 检测】</a></h3>
<table><thead><tr><th>lint name</th><th>Clippy 可检测</th><th>Rustc 可检测</th><th>Lint Group</th><th>level</th></tr></thead><tbody>
<tr><td><a href="https://rust-lang.github.io/rust-clippy/master/#chars_last_cmp">chars_last_cmp</a></td><td>yes</td><td>no</td><td>style</td><td>warn</td></tr>
<tr><td><a href="https://rust-lang.github.io/rust-clippy/master/#chars_next_cmp">chars_next_cmp</a></td><td>yes</td><td>no</td><td>style</td><td>warn</td></tr>
</tbody></table>
<h3><a class="header" href="#描述-3" id="描述-3">【描述】</a></h3>
<p>Rust 语言 核心库 和 标准库都对字符串内置了一些方便的方法来处理这类需求。</p>
<p>迭代字符的性能虽然也很快（对500多个字符迭代转义处理大概需要4.5微秒左右），但这种场景用迭代的话，代码可读性更差一些。</p>
<p>【正例】</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let name = &quot;_&quot;;
name.ends_with('_') || name.ends_with('-');

let name = &quot;foo&quot;;
if name.starts_with('_') {};
<span class="boring">}
</span></code></pre></pre>
<p>【反例】</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let name = &quot;_&quot;;
name.chars().last() == Some('_') || name.chars().next_back() == Some('-');

let name = &quot;foo&quot;;
if name.chars().next() == Some('_') {};
<span class="boring">}
</span></code></pre></pre>
<h2><a class="header" href="#gstr05---对字符串按指定位置进行切片的时候需要小心破坏其-utf-8-编码" id="gstr05---对字符串按指定位置进行切片的时候需要小心破坏其-utf-8-编码">G.STR.05   对字符串按指定位置进行切片的时候需要小心破坏其 UTF-8 编码</a></h2>
<h3><a class="header" href="#级别建议-4" id="级别建议-4">【级别：建议】</a></h3>
<p>建议按此规范执行。</p>
<h3><a class="header" href="#lint-检测-4" id="lint-检测-4">【Lint 检测】</a></h3>
<table><thead><tr><th>lint name</th><th>Clippy 可检测</th><th>Rustc 可检测</th><th>Lint Group</th><th>level</th></tr></thead><tbody>
<tr><td><a href="https://rust-lang.github.io/rust-clippy/master/#string_slice">string_slice</a></td><td>yes</td><td>no</td><td>restriction</td><td>allow</td></tr>
</tbody></table>
<h3><a class="header" href="#描述-4" id="描述-4">【描述】</a></h3>
<p>字符串默认是合法的 <code>UTF-8</code>字节序列，如果通过指定索引位置来对字符串进行切片，有可能破坏其合法 <code>UTF-8</code> 编码，除非这个位置是确定的，比如按 <code>char_indices</code> 方法来定位是合法的。</p>
<p>【正例】</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let s = &quot;Ölkanne&quot;;
let mut char_indices = s.char_indices();
assert_eq!(Some((0, 'Ö')), char_indices.next());
// assert_eq!(Some((2, 'l')), char_indices.next()); 
let pos = if let Some((pos, _)) = char_indices.next(){ pos } else {0};
let sub_s = &amp;s[pos..];
assert_eq!(&quot;lkanne&quot;, sub_s);
<span class="boring">}
</span></code></pre></pre>
<p>【反例】</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let s = &quot;Ölkanne&quot;;
// thread 'main' panicked at 'byte index 1 is not a char boundary; 
// it is inside 'Ö' (bytes 0..2) of `Ölkanne`'
let sub_s = &amp;s[1..];
// println!(&quot;{:?}&quot;, sub_s);
<span class="boring">}
</span></code></pre></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../safe-guides/coding_practice/control-flow.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../safe-guides/coding_practice/collections.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../safe-guides/coding_practice/control-flow.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../safe-guides/coding_practice/collections.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="../../mermaid.min.js"></script>
        
        <script type="text/javascript" src="../../mermaid-init.js"></script>
        

        

    </body>
</html>
